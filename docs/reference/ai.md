<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# ai

```go
import "github.com/IMBotPlatform/IMBotCore/pkg/ai"
```

## Index

- [type AgentOptions](<#AgentOptions>)
- [type ChatOption](<#ChatOption>)
  - [func WithModel\(model string\) ChatOption](<#WithModel>)
- [type ChatOptions](<#ChatOptions>)
- [type Config](<#Config>)
  - [func LoadConfig\(path string\) \(\*Config, error\)](<#LoadConfig>)
- [type FileStore](<#FileStore>)
  - [func NewFileStore\(baseDir string\) \(\*FileStore, error\)](<#NewFileStore>)
  - [func \(s \*FileStore\) AddAIMessage\(ctx context.Context, sessionID, text string\) error](<#FileStore.AddAIMessage>)
  - [func \(s \*FileStore\) AddUserMessage\(ctx context.Context, sessionID, text string\) error](<#FileStore.AddUserMessage>)
  - [func \(s \*FileStore\) ClearHistory\(ctx context.Context, sessionID string\) error](<#FileStore.ClearHistory>)
  - [func \(s \*FileStore\) GetHistory\(ctx context.Context, sessionID string\) \(\[\]llms.ChatMessage, error\)](<#FileStore.GetHistory>)
- [type ModelConfig](<#ModelConfig>)
- [type Service](<#Service>)
  - [func NewService\(config \*Config, store SessionStore\) \*Service](<#NewService>)
  - [func \(s \*Service\) Chat\(ctx context.Context, sessionID, prompt string, opts ...ChatOption\) \(\<\-chan string, error\)](<#Service.Chat>)
  - [func \(s \*Service\) RunAgent\(ctx context.Context, sessionID, prompt string, opts AgentOptions\) \(string, error\)](<#Service.RunAgent>)
- [type SessionStore](<#SessionStore>)
- [type ToolDefinition](<#ToolDefinition>)


<a name="AgentOptions"></a>
## type AgentOptions

AgentOptions 定义 Agent 运行时的选项

```go
type AgentOptions struct {
    Model      string
    Tools      []ToolDefinition
    MaxTurns   int
    StreamFunc func(string) // 用于实时流式输出中间思考过程或工具结果
}
```

<a name="ChatOption"></a>
## type ChatOption

ChatOption 是配置 ChatOptions 的函数。

```go
type ChatOption func(*ChatOptions)
```

<a name="WithModel"></a>
### func WithModel

```go
func WithModel(model string) ChatOption
```

WithModel 指定使用的模型。

<a name="ChatOptions"></a>
## type ChatOptions

ChatOptions 定义调用 Chat 时的配置。

```go
type ChatOptions struct {
    Model string
}
```

<a name="Config"></a>
## type Config

Config holds the global AI configuration.

```go
type Config struct {
    DefaultModel string        `json:"default_model" yaml:"default_model"`
    Models       []ModelConfig `json:"models" yaml:"models"`
}
```

<a name="LoadConfig"></a>
### func LoadConfig

```go
func LoadConfig(path string) (*Config, error)
```

LoadConfig reads and parses the configuration from a YAML file.

<a name="FileStore"></a>
## type FileStore

FileStore 实现了基于文件系统的 SessionStore \(JSONL 格式\)。 每个 Session 的历史记录存储在单独的文件中，每行一个 JSON 对象。

```go
type FileStore struct {
    // contains filtered or unexported fields
}
```

<a name="NewFileStore"></a>
### func NewFileStore

```go
func NewFileStore(baseDir string) (*FileStore, error)
```

NewFileStore 创建一个新的 FileStore。 baseDir: 存储历史记录的目录路径。

<a name="FileStore.AddAIMessage"></a>
### func \(\*FileStore\) AddAIMessage

```go
func (s *FileStore) AddAIMessage(ctx context.Context, sessionID, text string) error
```

AddAIMessage 添加 AI 消息（追加写入）

<a name="FileStore.AddUserMessage"></a>
### func \(\*FileStore\) AddUserMessage

```go
func (s *FileStore) AddUserMessage(ctx context.Context, sessionID, text string) error
```

AddUserMessage 添加用户消息（追加写入）

<a name="FileStore.ClearHistory"></a>
### func \(\*FileStore\) ClearHistory

```go
func (s *FileStore) ClearHistory(ctx context.Context, sessionID string) error
```

ClearHistory 清空会话历史（删除文件）

<a name="FileStore.GetHistory"></a>
### func \(\*FileStore\) GetHistory

```go
func (s *FileStore) GetHistory(ctx context.Context, sessionID string) ([]llms.ChatMessage, error)
```

GetHistory 逐行读取文件获取历史记录

<a name="ModelConfig"></a>
## type ModelConfig

ModelConfig defines the configuration for a single LLM.

```go
type ModelConfig struct {
    Name        string  `json:"name" yaml:"name"`                             // e.g., "gemini-pro", "gpt-4"
    Provider    string  `json:"provider" yaml:"provider"`                     // e.g., "openai", "google", "ollama"
    APIKey      string  `json:"api_key" yaml:"api_key"`                       // Environment variable reference or direct key
    BaseURL     string  `json:"base_url,omitempty" yaml:"base_url,omitempty"` // Optional: for custom endpoints
    ModelName   string  `json:"model_name" yaml:"model_name"`                 // The specific model ID (e.g., "gemini-1.5-pro")
    MaxTokens   int     `json:"max_tokens" yaml:"max_tokens"`                 // Max output tokens
    Temperature float64 `json:"temperature" yaml:"temperature"`               // Creativity
}
```

<a name="Service"></a>
## type Service

Service 是 AI 逻辑的主要入口点。 它负责管理模型实例、会话状态以及与 LLM 的交互。

```go
type Service struct {
    // contains filtered or unexported fields
}
```

<a name="NewService"></a>
### func NewService

```go
func NewService(config *Config, store SessionStore) *Service
```

NewService 创建一个新的 AI 服务实例。

<a name="Service.Chat"></a>
### func \(\*Service\) Chat

```go
func (s *Service) Chat(ctx context.Context, sessionID, prompt string, opts ...ChatOption) (<-chan string, error)
```

Chat 处理用户的消息，与 LLM 交互，并返回流式响应。

核心架构流程图:

```
User Input (String)
      |
      v
+-------------------------+
| SessionStore (Memory)   |
| 1. Save User Message    |
| 2. Load Full History    |
+-----------+-------------+
            |
            v
+-------------------------+
| LLM Provider (OpenAI/..) |
| 3. StreamChat()         |
+-----------+-------------+
            |
            +-------------------------> [Output Channel] -> (Stream to User)
            |
            v
+-------------------------+
| SessionStore            |
| 4. Save AI Response     |
+-------------------------+
```

<a name="Service.RunAgent"></a>
### func \(\*Service\) RunAgent

```go
func (s *Service) RunAgent(ctx context.Context, sessionID, prompt string, opts AgentOptions) (string, error)
```

RunAgent 运行一个支持工具调用的 Agent 循环

<a name="SessionStore"></a>
## type SessionStore

SessionStore manages the persistence of chat history.

```go
type SessionStore interface {
    // GetHistory retrieves the chat history for a given session.
    GetHistory(ctx context.Context, sessionID string) ([]llms.ChatMessage, error)

    // AddUserMessage adds a user message to the session history.
    AddUserMessage(ctx context.Context, sessionID, text string) error

    // AddAIMessage adds an AI response to the session history.
    AddAIMessage(ctx context.Context, sessionID, text string) error

    // ClearHistory clears the session history.
    ClearHistory(ctx context.Context, sessionID string) error
}
```

<a name="ToolDefinition"></a>
## type ToolDefinition

ToolDefinition 定义工具的接口

```go
type ToolDefinition struct {
    Name        string
    Description string
    Parameters  json.RawMessage // JSON Schema
    Function    func(ctx context.Context, args string) (string, error)
}
```

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
